name: Build Calendars

on:
  workflow_call:
    inputs:
      artifact-name:
        description: "Name for the uploaded artifact"
        required: false
        default: "github-pages"
        type: string
    outputs:
      error-count:
        description: "Number of errors during calendar generation"
        value: ${{ jobs.build.outputs.error-count }}
      zero-event-calendars:
        description: "Newline-separated list of calendars with 0 events"
        value: ${{ jobs.build.outputs.zero-event-calendars }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      error-count: ${{ steps.generate-calendars.outputs.ERROR_COUNT }}
      zero-event-calendars: ${{ steps.generate-calendars.outputs.ZERO_EVENT_CALENDARS }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Run unit tests
      run: npm run test:all

    - name: Generate calendars
      id: generate-calendars
      env:
        TICKETMASTER_API_KEY: ${{ secrets.TICKETMASTER_API_KEY }}
      run: |
        npm run generate-calendars
        cat errorCount.txt
        echo "ERROR_COUNT=$(cat errorCount.txt)" >> "$GITHUB_OUTPUT"
        cat zeroEventCalendars.txt
        {
          echo 'ZERO_EVENT_CALENDARS<<EOF'
          cat zeroEventCalendars.txt
          echo 'EOF'
        } >> "$GITHUB_OUTPUT"

    - name: Build web interface
      run: npm run web:build

    - name: Get GitHub Pages URL
      id: get-pages-url
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Try to get the GitHub Pages URL, fail gracefully if not configured
        PAGES_URL=$(gh api repos/${{ github.repository }}/pages --jq '.html_url' 2>/dev/null || echo "")
        echo "PAGES_URL=${PAGES_URL}" >> "$GITHUB_OUTPUT"
        if [ -n "$PAGES_URL" ]; then
          echo "GitHub Pages URL: $PAGES_URL"
        else
          echo "GitHub Pages not configured or not accessible, skipping URL check"
        fi

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'output/'
        name: ${{ inputs.artifact-name }}

    - name: Check for missing calendar URLs
      if: steps.get-pages-url.outputs.PAGES_URL != ''
      run: npm run check-missing-urls -- "${{ steps.get-pages-url.outputs.PAGES_URL }}"
