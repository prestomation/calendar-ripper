name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    uses: ./.github/workflows/build-calendars.yml
    secrets: inherit
    with:
      artifact-name: pr-preview-${{ github.event.number }}
      include-favorites-api: false

  deploy-preview:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-preview-${{ github.event.number }}

      - name: Deploy to preview branch
        run: |
          # Move artifact to temp location so it survives branch checkout
          cp artifact.tar /tmp/artifact.tar

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Fetch and checkout existing preview branch, or create an orphan if it doesn't exist
          if git fetch origin pr-previews 2>/dev/null; then
            git checkout pr-previews
          else
            git checkout --orphan pr-previews
            git rm -rf . 2>/dev/null || true
          fi

          # Remove old preview for THIS PR if exists, then add the new one
          rm -rf pr-preview-${{ github.event.number }}
          mkdir -p pr-preview-${{ github.event.number }}
          tar -xf /tmp/artifact.tar -C pr-preview-${{ github.event.number }}

          git add pr-preview-${{ github.event.number }}
          git commit -m "Update PR #${{ github.event.number }} preview" || exit 0
          git push origin pr-previews --force

      - name: Extract build errors
        run: |
          mkdir -p /tmp/build-errors
          tar -xf /tmp/artifact.tar -C /tmp/build-errors 2>/dev/null || true
          if [ ! -f /tmp/build-errors/build-errors.json ]; then
            printf '{"totalErrors":0,"configErrors":[],"sources":[],"externalCalendarFailures":[]}' > /tmp/build-errors/build-errors.json
          fi

      - name: Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('ğŸ“… Calendar Preview')
            );

            const errorCount = '${{ needs.build.outputs.error-count }}';
            const errorBadge = errorCount === '0' ? 'âœ… No errors' : `âŒ ${errorCount} errors`;
            const previewUrl = `http://htmlpreview.github.io/?https://github.com/${{ github.repository }}/blob/pr-previews/pr-preview-${{ github.event.number }}/index.html`;

            const zeroEventCalendarsRaw = `${{ needs.build.outputs.zero-event-calendars }}`;
            const zeroEventCalendars = zeroEventCalendarsRaw.trim().split('\n').filter(Boolean);
            const zeroEventSection = zeroEventCalendars.length > 0
              ? `\n\n<details>\n<summary>âš ï¸ ${zeroEventCalendars.length} calendar(s) with 0 events</summary>\n\n${zeroEventCalendars.map(c => `- \`${c}\``).join('\n')}\n\n</details>`
              : '\n\nâœ… All calendars have events';

            // Read build-errors.json for detailed error breakdown
            const fs = require('fs');
            let buildErrors = { configErrors: [], sources: [], externalCalendarFailures: [] };
            try {
              buildErrors = JSON.parse(fs.readFileSync('/tmp/build-errors/build-errors.json', 'utf8'));
            } catch (e) {
              // File unavailable or parse failed â€” skip detailed breakdown
            }

            let errorSection = '';
            if (parseInt(errorCount) > 0) {
              const lines = [];
              const configErrors = buildErrors.configErrors || [];
              const sourceErrors = buildErrors.sources || [];
              const externalFailures = buildErrors.externalCalendarFailures || [];

              if (configErrors.length > 0) {
                lines.push(`**Config errors (${configErrors.length}):**`);
                configErrors.forEach(e => {
                  lines.push(`- \`${e.path || e.type || 'unknown'}\`: ${e.reason || 'No reason provided'}`);
                });
                lines.push('');
              }

              if (sourceErrors.length > 0) {
                const totalSourceErrors = sourceErrors.reduce((a, s) => a + (s.errorCount || 0), 0);
                lines.push(`**Parse errors in ${sourceErrors.length} calendar(s) (${totalSourceErrors} total):**`);
                sourceErrors.forEach(s => {
                  lines.push(`- \`${s.source || 'unknown'}/${s.calendar || 'unknown'}\`: ${s.errorCount || 0} error(s)`);
                });
                lines.push('');
              }

              if (externalFailures.length > 0) {
                lines.push(`**External calendar failures (${externalFailures.length}):**`);
                externalFailures.forEach(f => {
                  lines.push(`- \`${f.name || 'unknown'}\`: ${f.error || 'Unknown error'}`);
                });
                lines.push('');
              }

              if (lines.length > 0) {
                errorSection = `\n\n<details>\n<summary>ğŸ” ${errorCount} error(s) â€” click to expand</summary>\n\n${lines.join('\n')}\n</details>`;
              }
            }

            const body = [
              '## ğŸ“… Calendar Preview',
              '',
              `**Status:** ${errorBadge}`,
              `**Preview:** [View Calendar Index](${previewUrl})`,
              `**Commit:** ${{ github.event.pull_request.head.sha }}`,
              errorSection,
              zeroEventSection,
              '',
              '> ğŸ”— Preview powered by htmlpreview.github.io'
            ].join('\n');

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
