name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    uses: ./.github/workflows/build-calendars.yml
    with:
      artifact-name: pr-preview-${{ github.event.number }}

  deploy-preview:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup gh-pages branch
        run: |
          # Check if gh-pages branch exists
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "gh-pages branch exists, checking it out"
            git checkout gh-pages
          else
            echo "gh-pages branch doesn't exist, creating it"
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# GitHub Pages" > README.md
            git add README.md
            git commit -m "Initial gh-pages commit"
            git push origin gh-pages
          fi

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-preview-${{ github.event.number }}

      - name: Extract artifact to PR directory
        run: |
          rm -rf pr-${{ github.event.number }}
          mkdir -p pr-${{ github.event.number }}
          tar -xf artifact.tar -C pr-${{ github.event.number }}

      - name: Add PR info to preview
        run: |
          cat > pr-${{ github.event.number }}/pr-info.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>PR #${{ github.event.number }} Preview</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .pr-info { background: #f0f8ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
              .error-count { color: #d73a49; font-weight: bold; }
              .success-count { color: #28a745; font-weight: bold; }
            </style>
          </head>
          <body>
            <div class="pr-info">
              <h2>üîç PR Preview #${{ github.event.number }}</h2>
              <p><strong>Branch:</strong> ${{ github.head_ref }}</p>
              <p><strong>Commit:</strong> ${{ github.event.pull_request.head.sha }}</p>
              <p><strong>Errors:</strong> <span class="${{ needs.build.outputs.error-count == '0' && 'success-count' || 'error-count' }}">${{ needs.build.outputs.error-count }}</span></p>
              <p><a href="index.html">üìÖ View Calendar Index</a></p>
              <p><a href="../">‚Üê Back to Production Site</a></p>
            </div>
          </body>
          </html>
          EOF

      - name: Commit and push preview
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pr-${{ github.event.number }}/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update PR #${{ github.event.number }} preview"
            git push origin gh-pages
          fi

      - name: Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('üìÖ Calendar Preview')
            );
            
            const errorCount = '${{ needs.build.outputs.error-count }}';
            const errorBadge = errorCount === '0' ? '‚úÖ No errors' : `‚ùå ${errorCount} errors`;
            const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.number }}/`;
            
            const body = `## üìÖ Calendar Preview
            
            Preview for this PR is available at: ${previewUrl}
            
            **Status:** ${errorBadge}
            **Commit:** ${{ github.event.pull_request.head.sha }}
            **PR:** #${{ github.event.number }}
            
            The preview will be updated automatically when you push new commits.
            
            > ‚ö†Ô∏è This preview is deployed to a subdirectory and won't affect the production site.`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
