name: Pull Request Tests and Build

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      actions: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests
      run: npm run test

    - name: Generate calendars
      id: generate-calendars
      run: | 
        npm run generate-calendars
        cat errorCount.txt
        echo "ERROR_COUNT=$(cat errorCount.txt)" >> "$GITHUB_OUTPUT"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: generated-calendars-pr-${{ github.event.number }}
        path: 'output/'
        retention-days: 30

    - name: Check Error Count
      id: check-errors
      env:
        ERROR_COUNT: ${{ steps.generate-calendars.outputs.ERROR_COUNT }}
      # Fail this if we have a positive error count.
      # This way we keep uploading/deploying even if there are errors, but we get a notification from this failed step
      run: (( $ERROR_COUNT == 0 ))

    - name: Comment PR with results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          try {
            // First, check if we have permission to comment by testing with a safe API call
            let canComment = false;
            try {
              await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                per_page: 1
              });
              canComment = true;
              console.log('âœ… Permission check passed - can access PR comments');
            } catch (permError) {
              console.log('âš ï¸ Permission check failed - cannot access PR comments:', permError.message);
              canComment = false;
            }

            // Get artifacts from the build job
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const errorCount = '${{ steps.generate-calendars.outputs.ERROR_COUNT }}' || '0';
            const buildSuccessful = '${{ steps.check-errors.outcome }}' === 'success';
            const artifactName = `generated-calendars-pr-${{ github.event.number }}`;
            
            let message = `## ðŸ“… Calendar Generation Results\n\n`;
            
            // Check if we have artifacts
            const artifact = artifacts.artifacts.find(a => a.name === artifactName);
            
            if (artifact) {
              message += `âœ… **Calendars generated successfully!**\n\n`;
              message += `ðŸ“¦ **Download generated calendars:** [${artifact.name}](${artifact.archive_download_url})\n\n`;
              message += `> **Note:** You need to be logged into GitHub to download the artifact.\n\n`;
            } else {
              message += `âŒ **Calendar generation failed or artifacts not found.**\n\n`;
            }
            
            if (errorCount && errorCount !== '0') {
              message += `âš ï¸ **Warning:** ${errorCount} error(s) occurred during calendar generation.\n\n`;
            }
            
            if (!buildSuccessful) {
              message += `âš ï¸ **Build Status:** Some issues were detected during the build process.\n\n`;
            }
            
            message += `**Workflow run:** [View details](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
            
            // Only attempt to comment if we have permissions
            if (canComment) {
              try {
                // Find existing comment to update or create new one
                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                });
                
                const botComment = comments.find(comment => 
                  comment.user.type === 'Bot' && 
                  comment.body.includes('ðŸ“… Calendar Generation Results')
                );
                
                if (botComment) {
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: botComment.id,
                    body: message
                  });
                  console.log('âœ… Updated existing PR comment');
                } else {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: message
                  });
                  console.log('âœ… Created new PR comment');
                }
              } catch (commentError) {
                console.error('âŒ Failed to create/update PR comment:', commentError.message);
                throw commentError; // Re-throw to trigger fallback
              }
            } else {
              throw new Error('No permission to comment on PR');
            }
            
          } catch (error) {
            console.error('âš ï¸ Cannot comment on PR (likely due to fork permissions):', error.message);
            console.log('ðŸ“ Providing feedback through job summary instead...');
            
            // Fallback: Use job summary for feedback when commenting fails
            const errorCount = '${{ steps.generate-calendars.outputs.ERROR_COUNT }}' || '0';
            const buildSuccessful = '${{ steps.check-errors.outcome }}' === 'success';
            const artifactName = `generated-calendars-pr-${{ github.event.number }}`;
            
            let summary = '# ðŸ“… Calendar Generation Results\n\n';
            
            if (buildSuccessful && errorCount === '0') {
              summary += 'âœ… **Status:** Calendars generated successfully!\n\n';
            } else if (buildSuccessful && errorCount !== '0') {
              summary += `âš ï¸ **Status:** Calendars generated with ${errorCount} warning(s)\n\n`;
            } else {
              summary += 'âŒ **Status:** Calendar generation encountered issues\n\n';
            }
            
            summary += `ðŸ“¦ **Artifact:** ${artifactName}\n`;
            summary += `ðŸ”¢ **Error Count:** ${errorCount}\n`;
            summary += `âœ… **Build Successful:** ${buildSuccessful}\n\n`;
            summary += '> **Note:** Download the artifact from the workflow run to access generated calendars.\n';
            
            await core.summary
              .addRaw(summary)
              .write();
            
            console.log('âœ… Job summary created as fallback feedback mechanism');
            // Don't fail the workflow - this is expected behavior for fork PRs
          }