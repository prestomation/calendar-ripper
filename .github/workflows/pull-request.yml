name: Pull Request Tests and Build

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run unit tests
      run: npm run test

    - name: Generate calendars
      id: generate-calendars
      run: | 
        npm run generate-calendars
        cat errorCount.txt
        echo "ERROR_COUNT=$(cat errorCount.txt)" >> "$GITHUB_OUTPUT"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: generated-calendars-pr-${{ github.event.number }}
        path: output/
        retention-days: 30

    - name: Check Error Count
      env:
        ERROR_COUNT: ${{ steps.generate-calendars.outputs.ERROR_COUNT }}
      # Fail this if we have a positive error count.
      # This way we keep uploading artifacts even if there are errors, but we get a notification from this failed step
      run: (( $ERROR_COUNT == 0 ))

    - name: Comment PR with artifact link
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });
          
          const artifact = artifacts.artifacts.find(a => a.name === `generated-calendars-pr-${{ github.event.number }}`);
          
          let message = `## ðŸ“… Calendar Generation Results\n\n`;
          
          if (artifact) {
            message += `âœ… **Calendars generated successfully!**\n\n`;
            message += `ðŸ“¦ **Download generated calendars:** [generated-calendars-pr-${{ github.event.number }}](${artifact.archive_download_url})\n\n`;
            message += `> **Note:** You need to be logged into GitHub to download the artifact.\n\n`;
          } else {
            message += `âŒ **Calendar generation failed or artifacts not found.**\n\n`;
          }
          
          const errorCount = '${{ steps.generate-calendars.outputs.ERROR_COUNT }}';
          if (errorCount && errorCount !== '0') {
            message += `âš ï¸ **Warning:** ${errorCount} error(s) occurred during calendar generation.\n\n`;
          }
          
          message += `**Workflow run:** [View details](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
          
          // Find existing comment to update or create new one
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ðŸ“… Calendar Generation Results')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: message
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
          }